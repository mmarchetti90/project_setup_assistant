#!/usr/bin/env python3"""This script downloads the Reactome gene and/or compound sets and prepares a term2gene table.N.B. For compounds, it's better to filter for detectable metabolites/lipids.Parameters------------species : str    Target genus and species separeted by an underscore    (e.g. Homo_sapiens, Mus_musculus, etc)--genes    Include if genes are desired elements--compounds    Include if metabolites/lipids are desired elements"""### ---------------------------------------- ###def get_children_terms(c, parent_child):        children = set(parent_child.loc[parent_child.parent.isin(c), 'child'].to_list())        children.update(c)    if children == c:                return c        else:                return get_children_terms(children, parent_child)### ------------------MAIN------------------ ###import numpy as npimport pandas as pdimport requestsfrom sys import argv### Get desired species and what kind of elements to includespecies = argv[argv.index('--species') + 1].replace('_', ' ')genes_toggle = '--genes' in argvcompounds_toggle = '--compounds' in argv### Download pathways and hierarchy# Pathways' IDs to namespathways_ids_to_names = {}url = 'https://download.reactome.org/94/ReactomePathways.txt'response = requests.get(url)if response.status_code == 200:        data = response.content.decode('utf8').split('\n')        for d in data:                try:                    p_id, p_name, sp = d.split('\t')                        if sp == species:                                pathways_ids_to_names[p_id] = p_name                except:                        continueelse:        print(f'ERROR: could not retrieve the data.\nCheck the url: {url}')# Hierarchyurl = 'https://download.reactome.org/94/ReactomePathwaysRelation.txt'try:    data = pd.read_csv(url, sep='\t', header=None)    data.columns = ['parent', 'child']    hierarchy = data.loc[(data['parent'].isin(pathways_ids_to_names.keys())) |                         (data['child'].isin(pathways_ids_to_names.keys())),]except:        print(f'ERROR: could not retrieve the data.\nCheck the url: {url}')### Prepare term2gene# Init term2geneoutput_file = f'reactome_{species.replace(" ", "_").lower()}.tsv'with open(output_file, 'w') as output:        output.write('gs_name\telement_name\telement_origin')# Genesif genes_toggle:        # Download and parse data        url = 'https://download.reactome.org/94/Ensembl2Reactome_PE_Pathway.txt'        try:            data = pd.read_csv(url, sep='\t', header=None).iloc[:, [3, 0, 7]]        except:                print(f'ERROR: could not retrieve the data.\nCheck the url: {url}')        data.columns = ['gs_name', 'element_name', 'species']        data = data.loc[data['species'] == species,]        data = data.drop('species', axis=1)    data = data.loc[data['gs_name'].isin(pathways_ids_to_names.keys()),]        # Create entries for term2gene        term2gene_partial = ['']        for gs_id in np.unique(data['gs_name'].values):                gs_children = get_children_terms([gs_id], hierarchy)                gs_name = pathways_ids_to_names[gs_id]                elements = np.unique(data.loc[data['gs_name'].isin(gs_children), 'element_name'].values)                for e in elements:                        term2gene_partial.append(f'{gs_name}\t{e}\tensembl')        # Add data to term2gene        with open(output_file, 'a') as output:                output.write('\n'.join(term2gene_partial))# Compoundsif compounds_toggle:        # Download RefMet to convert ChEBI IDs to RefMet names        url = 'https://www.metabolomicsworkbench.org/databases/refmet/refmet_download.php'        try:            refmet = pd.read_csv(url, sep=',', index_col=None, header=0)        except:                print(f'ERROR: could not retrieve the data.\nCheck the url: {url}')        refmet = refmet.loc[~ refmet.chebi_id.isna(),]        refmet = refmet[['chebi_id', 'refmet_name']]        refmet['chebi_id'] = refmet['chebi_id'].astype(int).astype(str)        chebi_to_refmet = {chebi_id : refmet_id for _,(chebi_id,refmet_id) in refmet.iterrows()}        # Download and parse data        url = 'https://download.reactome.org/94/ChEBI2Reactome_PE_Pathway.txt'        try:                data = pd.read_csv(url, sep='\t', header=None).iloc[:, [3, 0, 7]]        except:                print(f'ERROR: could not retrieve the data.\nCheck the url: {url}')        data.columns = ['gs_name', 'element_name', 'species']        data = data.loc[data['species'] == species,]        data = data.drop('species', axis=1)    data = data.loc[data['gs_name'].isin(pathways_ids_to_names.keys()),]        # Create entries for term2gene        term2gene_partial = ['']        for gs_id in np.unique(data['gs_name'].values):                gs_children = get_children_terms([gs_id], hierarchy)                gs_name = pathways_ids_to_names[gs_id]                elements = np.unique(data.loc[data['gs_name'].isin(gs_children), 'element_name'].values)                for e in elements:                        e = str(e)                        if e in chebi_to_refmet.keys():                                term2gene_partial.append(f'{gs_name}\t{chebi_to_refmet[e]}\trefmet')                        else:                                term2gene_partial.append(f'{gs_name}\t{e}\tchebi')        # Add data to term2gene        with open(output_file, 'a') as output:                output.write('\n'.join(term2gene_partial))### Convert hierarchy pathways and save to filehierarchy.loc[:, 'parent'] = [pathways_ids_to_names[p] if p in pathways_ids_to_names else                              p                              for p in hierarchy['parent'].values]hierarchy.loc[:, 'child'] = [pathways_ids_to_names[p] if p in pathways_ids_to_names else                             p                             for p in hierarchy['child'].values]hierarchy.to_csv(f'reactome_hierarchy_{species.replace(" ", "_").lower()}.tsv', sep='\t', index=False)